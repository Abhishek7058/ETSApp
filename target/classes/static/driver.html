<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETS - Driver Interface</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        #map {
            height: 500px;
            width: 100%;
            margin-top: 20px;
        }
        .online-status {
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-block;
            margin: 10px 0;
        }
        .online {
            background-color: #28a745;
            color: white;
        }
        .offline {
            background-color: #dc3545;
            color: white;
        }
        .user-marker {
            padding: 5px;
            margin: 5px 0;
            border-radius: 3px;
            background-color: #f8f9fa;
        }
        .trip-card {
            margin-bottom: 10px;
            border-left: 5px solid #007bff;
        }
        .form-otp {
            max-width: 300px;
        }
        .trip-card.accepted {
            border-left: 5px solid #28a745;
        }
        .trip-card.arrived {
            border-left: 5px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>ETS - Driver Interface</h1>
        
        <div class="card">
            <div class="card-header">
                <h4>Connect to Tracking System</h4>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="driverId">Driver ID:</label>
                    <input type="text" class="form-control" id="driverId" placeholder="Enter your driver ID">
                </div>
                <div class="form-group">
                    <label for="slotId">Slot ID:</label>
                    <input type="text" class="form-control" id="slotId" placeholder="Enter slot ID to connect">
                </div>
                <button id="connectBtn" class="btn btn-primary">Connect</button>
                <button id="disconnectBtn" class="btn btn-danger" disabled>Disconnect</button>
                
                <div id="connectionStatus" class="online-status offline">Offline</div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-7">
                <div class="card">
                    <div class="card-header">
                        <h4>Trip Requests</h4>
                    </div>
                    <div class="card-body">
                        <div id="tripRequests"></div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h4>Connected Users</h4>
                    </div>
                    <div class="card-body">
                        <div id="connectedUsers"></div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h4>OTP Verification</h4>
                    </div>
                    <div class="card-body">
                        <div class="form-group form-otp">
                            <label for="userId">User ID:</label>
                            <input type="text" class="form-control" id="otpUserId" placeholder="Enter user ID">
                        </div>
                        <div class="form-group form-otp">
                            <label for="otpValue">OTP:</label>
                            <input type="text" class="form-control" id="otpValue" placeholder="Enter OTP">
                        </div>
                        <button id="sendOtpBtn" class="btn btn-primary" disabled>Send OTP to User</button>
                        <button id="verifyOtpBtn" class="btn btn-success ml-2" disabled>Verify OTP</button>
                        <div id="otpStatus" class="mt-2"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-5">
                <div id="map"></div>
                <div class="card mt-2 mb-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <span class="mr-2"><img src="https://maps.google.com/mapfiles/ms/icons/cabs.png" width="20" /> You (Driver)</span>
                                <span class="mr-2"><img src="http://maps.google.com/mapfiles/ms/icons/blue-dot.png" width="20" /> Users</span>
                            </div>
                            <div>
                                <span class="mr-2"><img src="http://maps.google.com/mapfiles/ms/icons/red-dot.png" width="20" /> Pickup</span>
                                <span class="mr-2"><img src="http://maps.google.com/mapfiles/ms/icons/purple-dot.png" width="20" /> Drop</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trip Information Panel -->
                <div class="card mb-2">
                    <div class="card-header">
                        <h5>Trip Information</h5>
                    </div>
                    <div class="card-body">
                        <div id="tripInfo">
                            <p><strong>Current Location:</strong> <span id="currentLocationText">-</span></p>
                            <p><strong>Distance to Pickup:</strong> <span id="distanceToPickup">-</span></p>
                            <p><strong>Trip Distance:</strong> <span id="tripDistance">-</span></p>
                            <p><strong>Estimated Time:</strong> <span id="estimatedTime">-</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript libraries -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        // Google Maps API Key
        const googleMapsApiKey = "AIzaSyCelDo4I5cPQ72TfCTQW-arhPZ7ALNcp8w";
        
        // WebSocket connection
        let stompClient = null;
        let connected = false;
        let driverId = '';
        let slotId = '';
        let map;
        let driverMarker;
        let activeTrips = {};
        
        // User markers
        let userMarkers = {};
        let connectedUsers = {};
        
        // Trip markers
        let tripMarkers = {};
        
        // Location tracking variables
        let watchId;
        let currentLat = 0;
        let currentLng = 0;
        
        // Global variables
        let tripInfoInterval = null;
        
        // Initialize Google Maps
        function initMap() {
            // Default position (will be updated with current location)
            const defaultPosition = { lat: 37.7749, lng: -122.4194 };
            
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15,
                center: defaultPosition,
            });
            
            // Create driver marker
            driverMarker = new google.maps.Marker({
                position: defaultPosition,
                map: map,
                title: "Your Location",
                icon: "https://maps.google.com/mapfiles/ms/icons/cabs.png"
            });
            
            // Get current position
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        currentLat = pos.lat;
                        currentLng = pos.lng;
                        
                        driverMarker.setPosition(pos);
                        map.setCenter(pos);
                    },
                    () => {
                        alert("Error getting your location. Using default position.");
                    }
                );
            }
        }
        
        // Connect to WebSocket
        function connect() {
            driverId = $("#driverId").val().trim();
            slotId = $("#slotId").val().trim();
            
            if (!driverId || !slotId) {
                alert("Please enter Driver ID and Slot ID");
                return;
            }
            
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                connected = true;
                
                // Enable/disable buttons
                $("#connectBtn").prop("disabled", true);
                $("#disconnectBtn").prop("disabled", false);
                $("#verifyOtpBtn").prop("disabled", false);
                $("#sendOtpBtn").prop("disabled", false);
                
                // Update connection status
                updateConnectionStatus(true);
                
                // Subscribe to topics
                stompClient.subscribe('/topic/slot/' + slotId, handleSlotMessages);
                stompClient.subscribe('/topic/slot/' + slotId + '/location', handleLocationMessages);
                stompClient.subscribe('/topic/slot/' + slotId + '/trips', handleTripMessages);
                stompClient.subscribe('/user/queue/location', handleUserLocation);
                stompClient.subscribe('/user/queue/trips', handleTripUpdates);
                
                // Send connection message
                sendConnectionMessage("CONNECTED");
                
                // Start sending location updates
                startLocationTracking();
            }, function(error) {
                console.error('Error connecting to WebSocket: ', error);
                alert('Failed to connect. Please try again.');
                connected = false;
                updateConnectionStatus(false);
            });
        }
        
        // Disconnect from WebSocket
        function disconnect() {
            if (stompClient !== null && connected) {
                // Send disconnect message
                sendConnectionMessage("DISCONNECTED");
                
                // Stop location tracking
                stopLocationTracking();
                
                // Clear user markers
                clearUserMarkers();
                
                // Clear trip markers
                clearTripMarkers();
                
                // Disconnect from WebSocket
                stompClient.disconnect(function() {
                    console.log("Disconnected");
                    connected = false;
                    
                    // Enable/disable buttons
                    $("#connectBtn").prop("disabled", false);
                    $("#disconnectBtn").prop("disabled", true);
                    $("#verifyOtpBtn").prop("disabled", true);
                    $("#sendOtpBtn").prop("disabled", true);
                    
                    // Update connection status
                    updateConnectionStatus(false);
                    
                    // Clear trip requests and connected users
                    $("#tripRequests").empty();
                    $("#connectedUsers").empty();
                });
            }
        }
        
        // Send connection message
        function sendConnectionMessage(status) {
            stompClient.send("/app/driver.connect", {}, JSON.stringify({
                slotId: slotId,
                driverId: driverId,
                status: status,
                messageType: "CONNECTION_UPDATE"
            }));
        }
        
        // Send location update
        function sendLocationUpdate() {
            if (connected) {
                stompClient.send("/app/location.update", {}, JSON.stringify({
                    slotId: slotId,
                    driverId: driverId,
                    userId: null,  // Explicitly set to null to ensure it's included in the message
                    latitude: currentLat,
                    longitude: currentLng,
                    timestamp: Date.now(),
                    messageType: "LOCATION_UPDATE"
                }));
            }
        }
        
        // Update trip status
        function updateTripStatus(userId, status) {
            stompClient.send("/app/trip.status", {}, JSON.stringify({
                slotId: slotId,
                userId: userId,
                driverId: driverId,
                status: status,
                messageType: "TRIP_UPDATE"
            }));
        }
        
        // Verify OTP
        function verifyOTP() {
            const userId = $("#otpUserId").val().trim();
            const otp = $("#otpValue").val().trim();
            
            if (!userId || !otp) {
                alert("Please enter User ID and OTP");
                return;
            }
            
            // Call the REST API to verify OTP
            $.ajax({
                url: "/api/trips/verify-otp",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    slotId: slotId,
                    userId: userId,
                    driverId: driverId,
                    otp: otp
                }),
                success: function(response) {
                    $("#otpStatus").html('<div class="alert alert-success">OTP verified successfully</div>');
                    updateTripStatus(userId, "PICKEDUP");
                    
                    // Clear the form
                    $("#otpUserId").val("");
                    $("#otpValue").val("");
                },
                error: function() {
                    $("#otpStatus").html('<div class="alert alert-danger">Invalid OTP</div>');
                }
            });
        }
        
        // Send OTP to user
        function sendOTPToUser() {
            const userId = $("#otpUserId").val().trim();
            
            if (!userId) {
                alert("Please enter User ID");
                return;
            }
            
            // Find active trip for this user
            let tripFound = false;
            for (const tripId in activeTrips) {
                const trip = activeTrips[tripId];
                if (trip.userId === userId) {
                    tripFound = true;
                    break;
                }
            }
            
            if (!tripFound) {
                $("#otpStatus").html('<div class="alert alert-warning">No active trip found for this user</div>');
                return;
            }
            
            // Call the REST API to send OTP
            $.ajax({
                url: "/api/trips/send-otp",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    slotId: slotId,
                    userId: userId,
                    driverId: driverId
                }),
                success: function(response) {
                    console.log("OTP sent successfully:", response);
                    $("#otpStatus").html('<div class="alert alert-success">OTP sent to user successfully</div>');
                    
                    // Also update trip status to ARRIVED if not already
                    for (const tripId in activeTrips) {
                        const trip = activeTrips[tripId];
                        if (trip.userId === userId && trip.status !== "ARRIVED") {
                            updateTripStatus(userId, "ARRIVED");
                            break;
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Failed to send OTP:", error, xhr.responseText);
                    $("#otpStatus").html('<div class="alert alert-danger">Failed to send OTP</div>');
                }
            });
        }
        
        // Start tracking location
        function startLocationTracking() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        currentLat = position.coords.latitude;
                        currentLng = position.coords.longitude;
                        
                        // Update driver marker on map
                        const pos = { lat: currentLat, lng: currentLng };
                        driverMarker.setPosition(pos);
                        
                        // Update current location text
                        updateCurrentLocationText(currentLat, currentLng);
                        
                        // Update distance to pickup for active trips
                        for (const tripId in activeTrips) {
                            const trip = activeTrips[tripId];
                            if (trip.status === "ACCEPTED" || trip.status === "ARRIVED") {
                                updateDistanceToPickup(trip.pickupLatitude, trip.pickupLongitude);
                            }
                        }
                        
                        // Send location update
                        sendLocationUpdate();
                    },
                    (error) => {
                        console.error("Error getting location: ", error);
                    },
                    { 
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }
        
        // Stop tracking location
        function stopLocationTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }
        
        // Handle slot messages
        function handleSlotMessages(message) {
            const data = JSON.parse(message.body);
            
            if (data.messageType === "CONNECTION_UPDATE") {
                // If it's a user connection update
                if (data.userId) {
                    if (data.status === "CONNECTED") {
                        // Add to connected users
                        connectedUsers[data.userId] = true;
                        updateConnectedUsersList();
                    } else {
                        // Remove from connected users
                        delete connectedUsers[data.userId];
                        updateConnectedUsersList();
                        
                        // Remove marker
                        removeUserMarker(data.userId);
                    }
                }
            }
        }
        
        // Handle location messages
        function handleLocationMessages(message) {
            const data = JSON.parse(message.body);
            
            console.log("Location message received:", data);
            
            if (data.messageType === "LOCATION_UPDATE") {
                // If it's a user location update
                if (data.userId) {
                    console.log("User location update received, userId:", data.userId);
                    updateUserMarker(data.userId, data.latitude, data.longitude);
                }
            }
        }
        
        // Handle trip messages
        function handleTripMessages(message) {
            const data = JSON.parse(message.body);
            
            if (data.messageType === "TRIP_UPDATE") {
                updateTripRequestsList(data);
                
                // Add/update trip markers if it's a new request
                if (data.status === "REQUESTED") {
                    addTripMarkers(data);
                } else if (data.status === "CANCELLED" || data.status === "COMPLETED") {
                    // Remove trip markers if cancelled or completed
                    removeTripMarkers(data.slotId + "-" + data.userId);
                }
                
                // Update trip information display
                if (data.status === "ACCEPTED" || data.status === "ARRIVED" || data.status === "PICKEDUP") {
                    updateTripInfoDisplay(data);
                }
            }
        }
        
        // Handle user location updates
        function handleUserLocation(message) {
            const data = JSON.parse(message.body);
            
            if (data.messageType === "LOCATION_UPDATE" && data.userId) {
                updateUserMarker(data.userId, data.latitude, data.longitude);
            }
        }
        
        // Handle trip updates
        function handleTripUpdates(message) {
            const data = JSON.parse(message.body);
            
            if (data.messageType === "TRIP_UPDATE") {
                updateTripRequestsList(data);
                
                // Add/update trip markers if it's a new request
                if (data.status === "REQUESTED") {
                    addTripMarkers(data);
                } else if (data.status === "CANCELLED" || data.status === "COMPLETED") {
                    // Remove trip markers if cancelled or completed
                    removeTripMarkers(data.slotId + "-" + data.userId);
                }
                
                // Update trip information display
                if (data.status === "ACCEPTED" || data.status === "ARRIVED" || data.status === "PICKEDUP") {
                    updateTripInfoDisplay(data);
                }
            }
        }
        
        // Update connection status indicator
        function updateConnectionStatus(online) {
            if (online) {
                $("#connectionStatus").removeClass("offline").addClass("online").text("Online");
            } else {
                $("#connectionStatus").removeClass("online").addClass("offline").text("Offline");
            }
        }
        
        // Update user marker on map
        function updateUserMarker(userId, lat, lng) {
            const pos = { lat: lat, lng: lng };
            
            // Create marker if it doesn't exist
            if (!userMarkers[userId]) {
                userMarkers[userId] = new google.maps.Marker({
                    position: pos,
                    map: map,
                    title: "User: " + userId,
                    icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                });
            } else {
                // Update existing marker
                userMarkers[userId].setPosition(pos);
            }
            
            // Add user to connected users if not already there
            if (!connectedUsers[userId]) {
                connectedUsers[userId] = true;
                updateConnectedUsersList();
            }
        }
        
        // Remove user marker from map
        function removeUserMarker(userId) {
            if (userMarkers[userId]) {
                userMarkers[userId].setMap(null);
                delete userMarkers[userId];
            }
        }
        
        // Clear all user markers
        function clearUserMarkers() {
            for (const userId in userMarkers) {
                userMarkers[userId].setMap(null);
            }
            userMarkers = {};
        }
        
        // Add trip markers to the map (pickup and drop)
        function addTripMarkers(trip) {
            const tripId = trip.slotId + "-" + trip.userId;
            
            // Remove existing markers if any
            removeTripMarkers(tripId);
            
            // Create new markers array for this trip
            tripMarkers[tripId] = [];
            
            // Add pickup marker
            const pickupMarker = new google.maps.Marker({
                position: { lat: trip.pickupLatitude, lng: trip.pickupLongitude },
                map: map,
                title: "Pickup: " + trip.pickupAddress,
                icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
            });
            
            // Add drop marker
            const dropMarker = new google.maps.Marker({
                position: { lat: trip.dropLatitude, lng: trip.dropLongitude },
                map: map,
                title: "Drop: " + trip.dropAddress,
                icon: "http://maps.google.com/mapfiles/ms/icons/purple-dot.png"
            });
            
            // Store markers
            tripMarkers[tripId].push(pickupMarker);
            tripMarkers[tripId].push(dropMarker);
            
            // Add info windows
            const pickupInfoWindow = new google.maps.InfoWindow({
                content: `<div><strong>Pickup:</strong> ${trip.pickupAddress}<br><strong>User:</strong> ${trip.userId}</div>`
            });
            
            const dropInfoWindow = new google.maps.InfoWindow({
                content: `<div><strong>Drop:</strong> ${trip.dropAddress}<br><strong>User:</strong> ${trip.userId}</div>`
            });
            
            pickupMarker.addListener("click", () => {
                pickupInfoWindow.open(map, pickupMarker);
            });
            
            dropMarker.addListener("click", () => {
                dropInfoWindow.open(map, dropMarker);
            });
            
            // Draw route from pickup to drop
            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: "#007bff",
                    strokeOpacity: 0.7,
                    strokeWeight: 5
                }
            });
            
            directionsRenderer.setMap(map);
            tripMarkers[tripId].push(directionsRenderer);
            
            // Calculate and display route
            directionsService.route(
                {
                    origin: { lat: trip.pickupLatitude, lng: trip.pickupLongitude },
                    destination: { lat: trip.dropLatitude, lng: trip.dropLongitude },
                    travelMode: google.maps.TravelMode.DRIVING
                },
                (response, status) => {
                    if (status === "OK") {
                        directionsRenderer.setDirections(response);
                        
                        // Update trip info with route details
                        const route = response.routes[0];
                        const leg = route.legs[0];
                        
                        // Calculate trip distance and time
                        const tripDistanceText = leg.distance.text;
                        const tripTimeText = leg.duration.text;
                        
                        // Update trip info panel
                        $("#tripDistance").text(tripDistanceText);
                        $("#estimatedTime").text(tripTimeText);
                    } else {
                        console.error("Directions request failed due to " + status);
                    }
                }
            );
            
            // Calculate distance from driver to pickup
            updateDistanceToPickup(trip.pickupLatitude, trip.pickupLongitude);
        }
        
        // Update distance to pickup
        function updateDistanceToPickup(pickupLat, pickupLng) {
            if (!pickupLat || !pickupLng) return;
            
            const driverPos = driverMarker.getPosition();
            const pickupPos = new google.maps.LatLng(pickupLat, pickupLng);
            
            const directionsService = new google.maps.DirectionsService();
            directionsService.route(
                {
                    origin: driverPos,
                    destination: pickupPos,
                    travelMode: google.maps.TravelMode.DRIVING
                },
                (response, status) => {
                    if (status === "OK") {
                        const route = response.routes[0];
                        const leg = route.legs[0];
                        
                        // Update trip info with distance to pickup
                        $("#distanceToPickup").text(leg.distance.text + " (" + leg.duration.text + ")");
                    }
                }
            );
        }
        
        // Update current location text with geocoded address
        function updateCurrentLocationText(lat, lng) {
            const geocoder = new google.maps.Geocoder();
            const latlng = { lat: lat, lng: lng };
            
            geocoder.geocode({ location: latlng }, (results, status) => {
                if (status === "OK" && results[0]) {
                    $("#currentLocationText").text(results[0].formatted_address);
                } else {
                    $("#currentLocationText").text(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                }
            });
        }
        
        // Remove trip markers from the map
        function removeTripMarkers(tripId) {
            if (tripMarkers[tripId]) {
                for (const marker of tripMarkers[tripId]) {
                    if (marker instanceof google.maps.DirectionsRenderer) {
                        marker.setMap(null);
                    } else {
                        marker.setMap(null);
                    }
                }
                delete tripMarkers[tripId];
            }
        }
        
        // Clear all trip markers
        function clearTripMarkers() {
            for (const tripId in tripMarkers) {
                removeTripMarkers(tripId);
            }
        }
        
        // Update connected users list
        function updateConnectedUsersList() {
            const $usersList = $("#connectedUsers");
            $usersList.empty();
            
            let userCount = 0;
            for (const userId in connectedUsers) {
                $usersList.append(`
                    <div class="user-marker">
                        <strong>User ID:</strong> ${userId}
                        <button class="btn btn-sm btn-outline-primary float-right showUser" data-userid="${userId}">Show</button>
                    </div>
                `);
                userCount++;
            }
            
            if (userCount === 0) {
                $usersList.append('<div class="text-muted">No users connected</div>');
            } else {
                // Add event listeners to "Show" buttons
                $(".showUser").click(function() {
                    const userId = $(this).data("userid");
                    if (userMarkers[userId]) {
                        map.panTo(userMarkers[userId].getPosition());
                        map.setZoom(15);
                    }
                });
            }
        }
        
        // Update trip requests list
        function updateTripRequestsList(trip) {
            const tripId = trip.slotId + "-" + trip.userId;
            
            // Store in active trips
            if (!activeTrips[tripId] || activeTrips[tripId].status !== trip.status) {
                activeTrips[tripId] = trip;
                
                // Refresh the trips list
                renderTripRequests();
            }
        }
        
        // Render all trip requests
        function renderTripRequests() {
            const $tripsList = $("#tripRequests");
            $tripsList.empty();
            
            let tripCount = 0;
            for (const tripId in activeTrips) {
                const trip = activeTrips[tripId];
                
                // Skip completed or cancelled trips
                if (trip.status === "COMPLETED" || trip.status === "CANCELLED") {
                    continue;
                }
                
                let actionButtons = '';
                let statusClass = '';
                
                // Add appropriate action buttons based on status
                if (trip.status === "REQUESTED") {
                    actionButtons = `
                        <button class="btn btn-sm btn-success acceptTrip" data-userid="${trip.userId}">Accept</button>
                        <button class="btn btn-sm btn-danger rejectTrip" data-userid="${trip.userId}">Reject</button>
                        <button class="btn btn-sm btn-info showTrip" data-tripid="${tripId}">Show Route</button>
                    `;
                    statusClass = '';
                } else if (trip.status === "ACCEPTED") {
                    actionButtons = `
                        <button class="btn btn-sm btn-warning arrivedTrip" data-userid="${trip.userId}">Arrived</button>
                        <button class="btn btn-sm btn-info showTrip" data-tripid="${tripId}">Show Route</button>
                    `;
                    statusClass = 'accepted';
                } else if (trip.status === "ARRIVED") {
                    actionButtons = `
                        <button class="btn btn-sm btn-success pickupTrip" data-userid="${trip.userId}">Picked Up</button>
                        <button class="btn btn-sm btn-info showTrip" data-tripid="${tripId}">Show Route</button>
                    `;
                    statusClass = 'arrived';
                } else if (trip.status === "PICKEDUP") {
                    actionButtons = `
                        <button class="btn btn-sm btn-danger dropTrip" data-userid="${trip.userId}">Dropped</button>
                        <button class="btn btn-sm btn-info showTrip" data-tripid="${tripId}">Show Route</button>
                    `;
                    statusClass = 'pickedup';
                }
                
                $tripsList.append(`
                    <div class="card trip-card ${statusClass}">
                        <div class="card-body">
                            <h5 class="card-title">Trip Request: User ${trip.userId}</h5>
                            <p><strong>Status:</strong> ${trip.status}</p>
                            <p><strong>Pickup:</strong> ${trip.pickupAddress || 'Not specified'}</p>
                            <p><strong>Drop:</strong> ${trip.dropAddress || 'Not specified'}</p>
                            ${trip.rideType === "SCHEDULED" ? `<p><strong>Scheduled Time:</strong> ${new Date(trip.scheduledTime).toLocaleString()}</p>` : ''}
                            ${trip.requestTimestamp ? `<p><strong>Requested:</strong> ${new Date(trip.requestTimestamp).toLocaleTimeString()}</p>` : ''}
                            ${trip.pickupTimestamp ? `<p><strong>Picked up:</strong> ${new Date(trip.pickupTimestamp).toLocaleTimeString()}</p>` : ''}
                            <div class="btn-group">${actionButtons}</div>
                        </div>
                    </div>
                `);
                
                tripCount++;
            }
            
            if (tripCount === 0) {
                $tripsList.append('<div class="text-muted">No active trip requests</div>');
            }
            
            // Add event listeners to buttons
            $(".acceptTrip").click(function() {
                const userId = $(this).data("userid");
                updateTripStatus(userId, "ACCEPTED");
            });
            
            $(".rejectTrip").click(function() {
                const userId = $(this).data("userid");
                updateTripStatus(userId, "CANCELLED");
            });
            
            $(".arrivedTrip").click(function() {
                const userId = $(this).data("userid");
                updateTripStatus(userId, "ARRIVED");
                // Auto-fill the OTP user ID field
                $("#otpUserId").val(userId);
            });
            
            $(".pickupTrip").click(function() {
                const userId = $(this).data("userid");
                updateTripStatus(userId, "PICKEDUP");
            });
            
            $(".dropTrip").click(function() {
                const userId = $(this).data("userid");
                updateTripStatus(userId, "COMPLETED");
                
                // Remove trip markers and the user marker
                removeTripMarkers(slotId + "-" + userId);
                removeUserMarker(userId);
            });
            
            $(".showTrip").click(function() {
                const tripId = $(this).data("tripid");
                const trip = activeTrips[tripId];
                
                // Center map on pickup location
                map.panTo({ lat: trip.pickupLatitude, lng: trip.pickupLongitude });
                map.setZoom(14); // Zoom out a bit to see both pickup and drop
            });
        }
        
        // Format time difference in a human-readable way
        function formatTimeDifference(startTime, endTime) {
            if (!startTime || !endTime) return "N/A";
            
            const diffMs = endTime - startTime;
            const minutes = Math.floor(diffMs / 60000);
            const seconds = Math.floor((diffMs % 60000) / 1000);
            
            return `${minutes}m ${seconds}s`;
        }
        
        // Update trip information display
        function updateTripInfoDisplay(tripData) {
            if (tripData.pickupTimestamp && tripData.status === "PICKEDUP") {
                const now = Date.now();
                const pickupTime = tripData.pickupTimestamp;
                const elapsed = formatTimeDifference(pickupTime, now);
                
                $("#tripInfo").html(`
                    <p><strong>Current Location:</strong> <span id="currentLocationText">-</span></p>
                    <p><strong>Trip Duration:</strong> ${elapsed}</p>
                    <p><strong>Trip Distance:</strong> <span id="tripDistance">${$("#tripDistance").text()}</span></p>
                    <p><strong>Estimated Time:</strong> <span id="estimatedTime">${$("#estimatedTime").text()}</span></p>
                `);
                
                // Update every second
                if (window.tripInfoInterval) clearInterval(window.tripInfoInterval);
                window.tripInfoInterval = setInterval(() => {
                    const newElapsed = formatTimeDifference(pickupTime, Date.now());
                    $("p:contains('Trip Duration')").html(`<strong>Trip Duration:</strong> ${newElapsed}`);
                }, 1000);
            }
        }
        
        // Event listeners
        $(document).ready(function() {
            $("#connectBtn").click(connect);
            $("#disconnectBtn").click(disconnect);
            $("#verifyOtpBtn").click(verifyOTP);
            $("#sendOtpBtn").click(sendOTPToUser);
            
            // Handle page unload
            $(window).on('beforeunload', function() {
                disconnect();
            });
        });
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCelDo4I5cPQ72TfCTQW-arhPZ7ALNcp8w&libraries=places,geometry&callback=initMap" async defer></script>
</body>
</html> 