<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETS - User Interface</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        #map {
            height: 500px;
            width: 100%;
            margin-top: 20px;
        }
        .online-status {
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-block;
            margin: 10px 0;
        }
        .online {
            background-color: #28a745;
            color: white;
        }
        .offline {
            background-color: #dc3545;
            color: white;
        }
        .otp-display {
            font-size: 24px;
            font-weight: bold;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            letter-spacing: 5px;
            display: none;
            border: 2px dashed #007bff;
            color: #007bff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* Pulse animation for OTP display */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
            }
        }
        
        /* Highlight class for OTP display */
        .otp-highlight {
            animation: pulse 2s infinite;
            background-color: #e3f2fd;
            border: 2px solid #007bff;
        }
        
        .pac-container {
            z-index: 1051 !important;
        }
        #map-error {
            display: none;
            padding: 20px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .ride-status {
            padding: 10px 15px;
            border-radius: 5px;
            margin-top: 15px;
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        .status-heading {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .trip-info {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: 15px;
        }
        .trip-info-item {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            flex-basis: 48%;
            border-left: 3px solid #28a745;
        }
        .trip-info-item h5 {
            margin: 0;
            font-size: 14px;
            color: #6c757d;
        }
        .trip-info-item p {
            margin: 5px 0 0 0;
            font-size: 16px;
            font-weight: 600;
        }
        @media (max-width: 768px) {
            .trip-info-item {
                flex-basis: 100%;
            }
        }
        #slotUsers {
            margin-top: 10px;
        }
        .slot-user {
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 10px;
            padding: 4px 8px;
            background-color: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #dee2e6;
            font-size: 12px;
        }
        .slot-user.current {
            background-color: #e3f2fd;
            border-color: #b3d7ff;
        }
        .trip-status-alert {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>ETS - User Interface</h1>
        
        <div class="card">
            <div class="card-header">
                <h4>Connect to Tracking System</h4>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="userId">User ID:</label>
                    <input type="text" class="form-control" id="userId" placeholder="Enter your user ID">
                </div>
                <div class="form-group">
                    <label for="slotId">Slot ID:</label>
                    <input type="text" class="form-control" id="slotId" placeholder="Enter slot ID to connect">
                </div>
                <button id="connectBtn" class="btn btn-primary">Connect</button>
                <button id="disconnectBtn" class="btn btn-danger" disabled>Disconnect</button>
                
                <div id="driverStatus" class="online-status offline">Driver Offline</div>
                
                <div id="slotUsers" class="mt-2"></div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h4>Trip Request</h4>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="rideTypeTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="instant-tab" data-toggle="tab" href="#instantRide" role="tab">Instant Ride</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="scheduled-tab" data-toggle="tab" href="#scheduledRide" role="tab">Scheduled Ride</a>
                    </li>
                </ul>
                
                <div class="tab-content mt-3">
                    <div class="tab-pane fade show active" id="instantRide" role="tabpanel">
                        <div class="form-group">
                            <label for="pickupAddress">Pickup Location:</label>
                            <input type="text" class="form-control" id="pickupAddress" placeholder="Enter pickup address">
                        </div>
                        <div class="form-group">
                            <label for="dropAddress">Drop Location:</label>
                            <input type="text" class="form-control" id="dropAddress" placeholder="Enter drop address">
                        </div>
                        <button id="requestTripBtn" class="btn btn-success" disabled>Request Instant Ride</button>
                    </div>
                    
                    <div class="tab-pane fade" id="scheduledRide" role="tabpanel">
                        <div class="form-group">
                            <label for="scheduledPickupAddress">Pickup Location:</label>
                            <input type="text" class="form-control" id="scheduledPickupAddress" placeholder="Enter pickup address">
                        </div>
                        <div class="form-group">
                            <label for="scheduledDropAddress">Drop Location:</label>
                            <input type="text" class="form-control" id="scheduledDropAddress" placeholder="Enter drop address">
                        </div>
                        <div class="form-group">
                            <label for="scheduledTime">Pickup Time:</label>
                            <input type="datetime-local" class="form-control" id="scheduledTime">
                        </div>
                        <button id="scheduleRideBtn" class="btn btn-primary" disabled>Schedule Ride</button>
                    </div>
                </div>
                
                <div id="tripStatus" class="ride-status mt-3" style="display: none;"></div>
                <div id="otpDisplay" class="otp-display"></div>
                
                <div class="trip-info" id="tripInfo" style="display: none;">
                    <!-- Trip info will be dynamically added here -->
                </div>
            </div>
        </div>
        
        <div id="map-error"></div>
        <div id="map"></div>
        
        <div class="card mt-2 mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <span class="mr-2"><img src="http://maps.google.com/mapfiles/ms/icons/blue-pushpin.png" width="20" /> You</span>
                        <span class="mr-2"><img src="https://maps.google.com/mapfiles/ms/icons/cabs.png" width="20" /> Driver</span>
                    </div>
                    <div>
                        <span class="mr-2"><img src="http://maps.google.com/mapfiles/ms/icons/red-dot.png" width="20" /> Pickup</span>
                        <span class="mr-2"><img src="http://maps.google.com/mapfiles/ms/icons/purple-dot.png" width="20" /> Drop</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript libraries -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    <!-- Main script with fixed Google Maps implementation -->
    <script>
        // Handle Google Maps authentication failure
        function gm_authFailure() {
            $('#map-error').html('Google Maps API key is invalid or has expired. Please check your API key.').show();
            $('#map').hide();
        }

        // WebSocket connection
        let stompClient = null;
        let connected = false;
        let userId = '';
        let slotId = '';
        let map;
        let userMarker;
        let driverMarker;
        let driverOnline = false;
        
        // Location tracking variables
        let watchId;
        let currentLat = 0;
        let currentLng = 0;
        
        // Places autocomplete
        let pickupAutocomplete;
        let dropAutocomplete;
        let pickupLatLng = null;
        let dropLatLng = null;
        
        // Map features
        let pickupMarker;
        let dropMarker;
        let directionsRenderer;
        let directionsService;
        
        // Initialize Google Maps
        function initMap() {
            try {
                // Hide error message if shown previously
                $('#map-error').hide();
                $('#map').show();
                
                // Default position (will be updated with current location)
                const defaultPosition = { lat: 37.7749, lng: -122.4194 };
                
                // Create the map
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 15,
                    center: defaultPosition,
                });
                
                // Initialize directions service
                directionsService = new google.maps.DirectionsService();
                
                // Create markers (they will be positioned later)
                userMarker = new google.maps.Marker({
                    position: defaultPosition,
                    map: map,
                    title: "Your Location",
                    icon: "http://maps.google.com/mapfiles/ms/icons/blue-pushpin.png"
                });
                
                driverMarker = new google.maps.Marker({
                    position: defaultPosition,
                    map: map,
                    title: "Driver Location",
                    icon: "https://maps.google.com/mapfiles/ms/icons/cabs.png",
                    visible: false
                });
                
                // Create pickup and drop markers
                pickupMarker = new google.maps.Marker({
                    map: map,
                    title: "Pickup Location",
                    icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
                    visible: false
                });
                
                dropMarker = new google.maps.Marker({
                    map: map,
                    title: "Drop Location",
                    icon: "http://maps.google.com/mapfiles/ms/icons/purple-dot.png",
                    visible: false
                });
                
                // Add click event to map for selecting locations
                map.addListener("click", (event) => {
                    // Check if pickup or drop is currently selected
                    const activeLocationField = document.activeElement;
                    const isPickupActive = activeLocationField && activeLocationField.id === "pickupAddress";
                    const isDropActive = activeLocationField && activeLocationField.id === "dropAddress";
                    
                    if (isPickupActive) {
                        // Set pickup location
                        setPickupLocation(event.latLng);
                    } else if (isDropActive) {
                        // Set drop location
                        setDropLocation(event.latLng);
                    } else {
                        // Default to drop location if no field is focused
                        setDropLocation(event.latLng);
                    }
                });
                
                // Initialize places autocomplete
                initPlacesAutocomplete();
                
                // Get current position
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            currentLat = pos.lat;
                            currentLng = pos.lng;
                            
                            userMarker.setPosition(pos);
                            map.setCenter(pos);
                            
                            // Update autocomplete bias after getting location
                            updateAutocompleteBias(pos.lat, pos.lng);
                        },
                        (error) => {
                            console.error("Geolocation error:", error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                } else {
                    console.error("Browser doesn't support geolocation");
                }
            } catch (error) {
                console.error("Error initializing map:", error);
                $('#map-error').html('Error initializing Google Maps: ' + error.message).show();
                $('#map').hide();
            }
        }
        
        // Initialize Places Autocomplete
        function initPlacesAutocomplete() {
            try {
                // Check if Google Places API is available
                if (!google.maps.places) {
                    console.error("Google Places API not loaded");
                    $('#map-error').html('Google Places API not loaded. Please check your API key.').show();
                    return;
                }
                
                // Initialize autocomplete for instant ride pickup address
                pickupAutocomplete = new google.maps.places.Autocomplete(
                    document.getElementById("pickupAddress"),
                    {
                        fields: ["formatted_address", "geometry", "name"],
                        types: ["geocode", "establishment"]
                    }
                );
                
                // Initialize autocomplete for instant ride drop address
                dropAutocomplete = new google.maps.places.Autocomplete(
                    document.getElementById("dropAddress"),
                    {
                        fields: ["formatted_address", "geometry", "name"],
                        types: ["geocode", "establishment"]
                    }
                );
                
                // Initialize autocomplete for scheduled ride pickup address
                const scheduledPickupAutocomplete = new google.maps.places.Autocomplete(
                    document.getElementById("scheduledPickupAddress"),
                    {
                        fields: ["formatted_address", "geometry", "name"],
                        types: ["geocode", "establishment"]
                    }
                );
                
                // Initialize autocomplete for scheduled ride drop address
                const scheduledDropAutocomplete = new google.maps.places.Autocomplete(
                    document.getElementById("scheduledDropAddress"),
                    {
                        fields: ["formatted_address", "geometry", "name"],
                        types: ["geocode", "establishment"]
                    }
                );
                
                // Set initial bias to wherever the map is centered
                updateAutocompleteBias(map.getCenter().lat(), map.getCenter().lng());
                
                // Listen for place selection on pickup
                pickupAutocomplete.addListener("place_changed", () => {
                    const place = pickupAutocomplete.getPlace();
                    
                    if (!place.geometry) {
                        console.error("Place has no geometry");
                        return;
                    }
                    
                    pickupLatLng = {
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng()
                    };
                    
                    // Update pickup marker on map
                    if (!pickupMarker) {
                        pickupMarker = new google.maps.Marker({
                            position: pickupLatLng,
                            map: map,
                            title: "Pickup Location",
                            icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                        });
                    } else {
                        pickupMarker.setPosition(pickupLatLng);
                    }
                    pickupMarker.setVisible(true);
                    
                    // Adjust map to show both user location and pickup
                    adjustMapBounds();
                });
                
                // Listen for place selection on drop
                dropAutocomplete.addListener("place_changed", () => {
                    const place = dropAutocomplete.getPlace();
                    
                    if (!place.geometry) {
                        console.error("Place has no geometry");
                        return;
                    }
                    
                    dropLatLng = {
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng()
                    };
                    
                    // Update drop marker on map
                    if (!dropMarker) {
                        dropMarker = new google.maps.Marker({
                            position: dropLatLng,
                            map: map,
                            title: "Drop Location",
                            icon: "http://maps.google.com/mapfiles/ms/icons/purple-dot.png"
                        });
                    } else {
                        dropMarker.setPosition(dropLatLng);
                    }
                    dropMarker.setVisible(true);
                    
                    // Adjust map to show both user location and pickup
                    adjustMapBounds();
                    
                    // If both pickup and drop are set, draw route
                    if (pickupLatLng) {
                        drawRoute();
                    }
                });
            } catch (error) {
                console.error("Error initializing Places Autocomplete:", error);
                $('#map-error').html('Error initializing Google Places: ' + error.message).show();
            }
        }
        
        // Update the autocomplete bias to current location
        function updateAutocompleteBias(lat, lng) {
            if (pickupAutocomplete && dropAutocomplete) {
                const geolocation = { lat: lat, lng: lng };
                const circle = new google.maps.Circle({
                    center: geolocation,
                    radius: 100000  // 100km radius for suggestions
                });
                
                pickupAutocomplete.setBounds(circle.getBounds());
                dropAutocomplete.setBounds(circle.getBounds());
            }
        }
        
        // Draw route between pickup and drop locations
        function drawRoute() {
            if (!pickupLatLng || !dropLatLng || !directionsService) return;
            
            try {
                if (!directionsRenderer) {
                    directionsRenderer = new google.maps.DirectionsRenderer({
                        suppressMarkers: true,
                        polylineOptions: {
                            strokeColor: "#007bff",
                            strokeOpacity: 0.7,
                            strokeWeight: 5
                        },
                        map: map
                    });
                }
                
                directionsService.route(
                    {
                        origin: pickupLatLng,
                        destination: dropLatLng,
                        travelMode: google.maps.TravelMode.DRIVING
                    },
                    (response, status) => {
                        if (status === "OK") {
                            directionsRenderer.setDirections(response);
                        } else {
                            console.error("Directions request failed due to " + status);
                            if (status === "ZERO_RESULTS") {
                                alert("No driving route found between these locations. Try different locations.");
                            }
                        }
                    }
                );
            } catch (error) {
                console.error("Error drawing route:", error);
            }
        }
        
        // Adjust map bounds to show all relevant markers
        function adjustMapBounds() {
            if (!map) return;
            
            try {
                const bounds = new google.maps.LatLngBounds();
                
                // Add user location
                bounds.extend(userMarker.getPosition());
                
                // Add pickup location if exists
                if (pickupMarker && pickupMarker.getVisible()) {
                    bounds.extend(pickupMarker.getPosition());
                }
                
                // Add drop location if exists
                if (dropMarker && dropMarker.getVisible()) {
                    bounds.extend(dropMarker.getPosition());
                }
                
                // Add driver location if visible
                if (driverMarker && driverMarker.getVisible()) {
                    bounds.extend(driverMarker.getPosition());
                }
                
                // Fit bounds with padding
                map.fitBounds(bounds);
            } catch (error) {
                console.error("Error adjusting map bounds:", error);
            }
        }
        
        // Connect to WebSocket
        function connect() {
            userId = $("#userId").val().trim();
            slotId = $("#slotId").val().trim();
            
            if (!userId || !slotId) {
                alert("Please enter User ID and Slot ID");
                return;
            }
            
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            // Enable debug mode to see WebSocket communication
            stompClient.debug = function(str) {
                console.log('STOMP: ' + str);
            };
            
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                connected = true;
                
                // Enable/disable buttons
                $("#connectBtn").prop("disabled", true);
                $("#disconnectBtn").prop("disabled", false);
                $("#requestTripBtn").prop("disabled", !driverOnline);
                $("#scheduleRideBtn").prop("disabled", !driverOnline);
                
                // Subscribe to topics
                stompClient.subscribe('/topic/slot/' + slotId, handleSlotMessages);
                stompClient.subscribe('/topic/slot/' + slotId + '/location', handleLocationMessages);
                stompClient.subscribe('/topic/slot/' + slotId + '/trips', handleTripMessages);
                
                // Important: Subscribe to user-specific destinations
                const userQueue = '/user/' + userId + '/queue';
                stompClient.subscribe(userQueue + '/notifications', handleNotifications);
                stompClient.subscribe(userQueue + '/location', handleDriverLocation);
                stompClient.subscribe(userQueue + '/trips', handleTripUpdates);
                
                console.log('Subscribed to user-specific queue: ' + userQueue);
                
                // Send connection message
                sendConnectionMessage("CONNECTED");
                
                // Start sending location updates
                startLocationTracking();
            }, function(error) {
                console.error('Error connecting to WebSocket: ', error);
                alert('Failed to connect. Please try again.');
                connected = false;
            });
        }
        
        // Disconnect from WebSocket
        function disconnect() {
            if (stompClient !== null && connected) {
                // Send disconnect message
                sendConnectionMessage("DISCONNECTED");
                
                // Stop location tracking
                stopLocationTracking();
                
                // Disconnect from WebSocket
                stompClient.disconnect(function() {
                    console.log("Disconnected");
                    connected = false;
                    
                    // Enable/disable buttons
                    $("#connectBtn").prop("disabled", false);
                    $("#disconnectBtn").prop("disabled", true);
                    $("#requestTripBtn").prop("disabled", true);
                    $("#scheduleRideBtn").prop("disabled", true);
                    
                    // Update driver status
                    updateDriverStatus(false);
                });
            }
        }
        
        // Send connection message
        function sendConnectionMessage(status) {
            stompClient.send("/app/user.connect", {}, JSON.stringify({
                slotId: slotId,
                userId: userId,
                status: status,
                messageType: "CONNECTION_UPDATE"
            }));
            
            // Update slot users after connection
            if (status === "CONNECTED") {
                updateSlotUsers();
            }
        }
        
        // Send location update
        function sendLocationUpdate() {
            if (connected) {
                stompClient.send("/app/location.update", {}, JSON.stringify({
                    slotId: slotId,
                    userId: userId,
                    latitude: currentLat,
                    longitude: currentLng,
                    timestamp: Date.now(),
                    messageType: "LOCATION_UPDATE"
                }));
            }
        }
        
        // Request a trip
        function requestTrip() {
            const pickupAddress = $("#pickupAddress").val().trim();
            const dropAddress = $("#dropAddress").val().trim();
            
            if (!pickupAddress || !dropAddress) {
                alert("Please enter pickup and drop locations");
                return;
            }
            
            // Use coordinates from Places API if available
            const pickupLat = pickupLatLng ? pickupLatLng.lat : currentLat;
            const pickupLng = pickupLatLng ? pickupLatLng.lng : currentLng;
            const dropLat = dropLatLng ? dropLatLng.lat : currentLat + 0.01;
            const dropLng = dropLatLng ? dropLatLng.lng : currentLng + 0.01;
            
            stompClient.send("/app/trip.request", {}, JSON.stringify({
                slotId: slotId,
                userId: userId,
                pickupLatitude: pickupLat,
                pickupLongitude: pickupLng,
                pickupAddress: pickupAddress,
                dropLatitude: dropLat,
                dropLongitude: dropLng,
                dropAddress: dropAddress,
                rideType: "INSTANT",
                messageType: "TRIP_UPDATE"
            }));
            
            // Immediately update trip status and show trip info
            $("#tripStatus").show().html(`
                <div class="status-heading">TRIP STATUS:</div>
                <div class="alert alert-info trip-status-alert">
                    Trip requested. Waiting for driver...
                </div>
            `);
            
            // Initialize and show trip info
            $("#tripInfo").html(`
                <div class="trip-info-item">
                    <h5>PICKUP</h5>
                    <p id="tripPickup">${pickupAddress}</p>
                </div>
                <div class="trip-info-item">
                    <h5>DROP</h5>
                    <p id="tripDrop">${dropAddress}</p>
                </div>
                <div class="trip-info-item">
                    <h5>DISTANCE</h5>
                    <p id="tripDistance">Calculating...</p>
                </div>
                <div class="trip-info-item">
                    <h5>ESTIMATED TIME</h5>
                    <p id="tripEta">Calculating...</p>
                </div>
            `).show();
            
            // Calculate and display trip metrics
            updateTripMetrics(pickupLat, pickupLng, dropLat, dropLng);
        }
        
        // Schedule a ride
        function scheduleRide() {
            const pickupAddress = $("#scheduledPickupAddress").val().trim();
            const dropAddress = $("#scheduledDropAddress").val().trim();
            const scheduledTime = $("#scheduledTime").val();
            
            if (!pickupAddress || !dropAddress || !scheduledTime) {
                alert("Please enter pickup location, drop location, and pickup time");
                return;
            }
            
            // Get coordinates from geocoding
            const geocoder = new google.maps.Geocoder();
            
            geocoder.geocode({ address: pickupAddress }, (pickupResults, pickupStatus) => {
                if (pickupStatus !== "OK") {
                    alert("Could not find pickup location. Please try a different address.");
                    return;
                }
                
                const pickupLat = pickupResults[0].geometry.location.lat();
                const pickupLng = pickupResults[0].geometry.location.lng();
                
                geocoder.geocode({ address: dropAddress }, (dropResults, dropStatus) => {
                    if (dropStatus !== "OK") {
                        alert("Could not find drop location. Please try a different address.");
                        return;
                    }
                    
                    const dropLat = dropResults[0].geometry.location.lat();
                    const dropLng = dropResults[0].geometry.location.lng();
                    
                    // Generate a random slot ID for the scheduled ride
                    const scheduledSlotId = "SCH-" + Math.floor(Math.random() * 10000);
                    
                    stompClient.send("/app/trip.request", {}, JSON.stringify({
                        slotId: slotId,
                        userId: userId,
                        pickupLatitude: pickupLat,
                        pickupLongitude: pickupLng,
                        pickupAddress: pickupAddress,
                        dropLatitude: dropLat,
                        dropLongitude: dropLng,
                        dropAddress: dropAddress,
                        scheduledTime: scheduledTime,
                        rideType: "SCHEDULED",
                        messageType: "TRIP_UPDATE"
                    }));
                    
                    $("#tripStatus").html(`Ride scheduled for ${new Date(scheduledTime).toLocaleString()}`);
                });
            });
        }
        
        // Start tracking location
        function startLocationTracking() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        currentLat = position.coords.latitude;
                        currentLng = position.coords.longitude;
                        
                        // Update user marker on map
                        const pos = { lat: currentLat, lng: currentLng };
                        userMarker.setPosition(pos);
                        
                        // Send location update
                        sendLocationUpdate();
                    },
                    (error) => {
                        console.error("Error getting location: ", error);
                    },
                    { 
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }
        
        // Stop tracking location
        function stopLocationTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }
        
        // Handle slot messages
        function handleSlotMessages(message) {
            const data = JSON.parse(message.body);
            
            if (data.messageType === "CONNECTION_UPDATE") {
                // If it's a driver connection update
                if (data.driverId) {
                    updateDriverStatus(data.status === "CONNECTED");
                }
                
                // Update the list of users in this slot
                updateSlotUsers();
            }
        }
        
        // Handle location messages
        function handleLocationMessages(message) {
            const data = JSON.parse(message.body);
            
            if (data.messageType === "LOCATION_UPDATE") {
                // If it's a driver location update
                if (data.driverId) {
                    updateDriverMarker(data.latitude, data.longitude);
                }
            }
        }
        
        // Handle trip messages
        function handleTripMessages(message) {
            const data = JSON.parse(message.body);
            
            if (data.messageType === "TRIP_UPDATE") {
                updateTripStatus(data);
            }
        }
        
        // Handle notifications
        function handleNotifications(message) {
            const data = JSON.parse(message.body);
            
            if (data.messageType === "CONNECTION_UPDATE") {
                if (data.driverId) {
                    updateDriverStatus(data.status === "CONNECTED");
                }
            }
        }
        
        // Handle driver location updates
        function handleDriverLocation(message) {
            const data = JSON.parse(message.body);
            
            if (data.messageType === "LOCATION_UPDATE" && data.driverId) {
                updateDriverMarker(data.latitude, data.longitude);
            }
        }
        
        // Handle trip updates
        function handleTripUpdates(message) {
            const data = JSON.parse(message.body);
            
            console.log("Trip update received:", data); // Log all incoming trip messages
            
            // Ensure we only process messages meant for this user
            if (data.userId && data.userId !== userId) {
                console.log("Ignored trip update for different user:", data.userId);
                return;
            }

            // Check specifically for OTP in the message
            if (data.otp) {
                console.log("OTP found in trip update:", data.otp);
                
                // Always display the OTP if it exists, regardless of status
                $("#otpDisplay").show().text(data.otp);
                
                // If the message doesn't explicitly set a status that would trigger
                // OTP display in updateTripStatus, force a status that will
                if (data.status !== "OTP_REQUESTED" && data.status !== "ARRIVED") {
                    console.log("Forcing OTP display for status:", data.status);
                    // Create a copy of the data with modified status to ensure OTP display
                    const modifiedData = {...data};
                    
                    // Store original status to restore later if needed
                    modifiedData._originalStatus = data.status;
                    modifiedData.status = "OTP_REQUESTED";
                    
                    // Update trip status with the modified data
                    updateTripStatus(modifiedData);
                    return;
                }
            }

            // Always update the trip status when we get a valid message
            updateTripStatus(data);
        }
        
        // Update driver status indicator
        function updateDriverStatus(online) {
            driverOnline = online;
            
            if (online) {
                $("#driverStatus").removeClass("offline").addClass("online").text("Driver Online");
            } else {
                $("#driverStatus").removeClass("online").addClass("offline").text("Driver Offline");
                driverMarker.setVisible(false);
            }
            
            // Enable/disable both trip request buttons based on driver status
            $("#requestTripBtn").prop("disabled", !online);
            $("#scheduleRideBtn").prop("disabled", !online);
        }
        
        // Update driver marker on map
        function updateDriverMarker(lat, lng) {
            const pos = { lat: lat, lng: lng };
            driverMarker.setPosition(pos);
            driverMarker.setVisible(true);
        }
        
        // Update trip status
        function updateTripStatus(data) {
            console.log("Updating trip status:", data); // Add logging to help debug
            
            // Always show the trip status container when we receive an update
            $("#tripStatus").show();
            
            // Initialize trip info if it doesn't exist
            if ($("#tripInfo").children().length === 0) {
                $("#tripInfo").html(`
                    <div class="trip-info-item">
                        <h5>PICKUP</h5>
                        <p id="tripPickup">-</p>
                    </div>
                    <div class="trip-info-item">
                        <h5>DROP</h5>
                        <p id="tripDrop">-</p>
                    </div>
                    <div class="trip-info-item">
                        <h5>DISTANCE</h5>
                        <p id="tripDistance">-</p>
                    </div>
                    <div class="trip-info-item">
                        <h5>ESTIMATED TIME</h5>
                        <p id="tripEta">-</p>
                    </div>
                `);
            }
            
            // Update pickup and drop addresses if available
            if (data.pickupAddress) {
                $("#tripPickup").text(data.pickupAddress);
            }
            
            if (data.dropAddress) {
                $("#tripDrop").text(data.dropAddress);
            }
            
            // Show the trip info section for active trips
            if (data.status !== "COMPLETED" && data.status !== "CANCELLED") {
                $("#tripInfo").show();
            } else {
                $("#tripInfo").hide();
            }
            
            // Check if OTP is present in the data
            if (data.otp) {
                console.log("OTP found in message:", data.otp);
                
                // Always show OTP if present, regardless of status
                $("#otpDisplay").show().text(data.otp);
                
                // Add highlight class to draw attention to the OTP
                $("#otpDisplay").removeClass("otp-highlight");
                setTimeout(() => {
                    $("#otpDisplay").addClass("otp-highlight");
                }, 10);
            } else {
                console.log("No OTP found in message");
                // Only hide OTP display if we're moving to a state where OTP is no longer needed
                if (["OTP_VERIFIED", "PICKEDUP", "COMPLETED", "CANCELLED"].includes(data.status)) {
                    $("#otpDisplay").hide().removeClass("otp-highlight");
                }
            }
            
            let statusMessage = "";
            let statusClass = "alert-info";
            
            switch (data.status) {
                case "REQUESTED":
                    statusMessage = "Trip requested. Waiting for driver...";
                    statusClass = "alert-info";
                    break;
                case "ACCEPTED":
                    statusMessage = "Trip accepted by driver. Driver is on the way.";
                    statusClass = "alert-success";
                    break;
                case "ARRIVED":
                    statusMessage = "Driver has arrived at your pickup location.";
                    statusClass = "alert-warning";
                    
                    // Add OTP message if it exists
                    if (data.otp) {
                        statusMessage += " Show the OTP below to the driver:";
                    }
                    break;
                case "OTP_REQUESTED":
                    statusMessage = "Driver has requested verification. Show the OTP below to the driver:";
                    statusClass = "alert-primary";
                    break;
                case "OTP_VERIFIED":
                    statusMessage = "OTP verified successfully. You will be picked up shortly.";
                    statusClass = "alert-success";
                    $("#otpDisplay").hide().removeClass("otp-highlight");
                    break;
                case "PICKEDUP":
                    statusMessage = "You've been picked up. Enjoy your ride!";
                    statusClass = "alert-success";
                    $("#otpDisplay").hide().removeClass("otp-highlight");
                    break;
                case "COMPLETED":
                    statusMessage = "Trip completed. Thank you for riding with us!";
                    statusClass = "alert-success";
                    $("#otpDisplay").hide().removeClass("otp-highlight");
                    clearRouteAndMarkers();
                    break;
                case "CANCELLED":
                    statusMessage = "Trip cancelled.";
                    statusClass = "alert-danger";
                    $("#otpDisplay").hide().removeClass("otp-highlight");
                    clearRouteAndMarkers();
                    break;
                default:
                    // For any other status
                    if (data.otp) {
                        statusMessage = "OTP for verification:";
                        statusClass = "alert-info";
                    }
            }
            
            // Update the trip status with modern alert styling
            $("#tripStatus").html(`
                <div class="status-heading">TRIP STATUS:</div>
                <div class="alert ${statusClass} trip-status-alert">
                    ${statusMessage}
                </div>
            `);
        }
        
        // Clear route and markers from the map
        function clearRouteAndMarkers() {
            // Clear directions
            if (directionsRenderer) {
                directionsRenderer.setMap(null);
                directionsRenderer = null;
            }
            
            // Hide pickup marker
            if (pickupMarker) {
                pickupMarker.setVisible(false);
            }
            
            // Hide drop marker
            if (dropMarker) {
                dropMarker.setVisible(false);
            }
            
            // Reset pickup and drop fields
            $("#pickupAddress").val("");
            $("#dropAddress").val("");
            
            // Reset coordinates
            pickupLatLng = null;
            dropLatLng = null;
        }
        
        // Set pickup location from map click
        function setPickupLocation(latLng) {
            pickupLatLng = {
                lat: latLng.lat(),
                lng: latLng.lng()
            };
            
            // Update marker
            pickupMarker.setPosition(latLng);
            pickupMarker.setVisible(true);
            
            // Reverse geocode the coordinates
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ location: latLng }, (results, status) => {
                if (status === "OK" && results[0]) {
                    $("#pickupAddress").val(results[0].formatted_address);
                    
                    // If drop location is also set, draw route
                    if (dropLatLng) {
                        drawRoute();
                    }
                    
                    // Adjust map bounds
                    adjustMapBounds();
                } else {
                    console.error("Geocoder failed due to: " + status);
                    $("#pickupAddress").val(`${latLng.lat().toFixed(6)}, ${latLng.lng().toFixed(6)}`);
                }
            });
        }
        
        // Set drop location from map click
        function setDropLocation(latLng) {
            dropLatLng = {
                lat: latLng.lat(),
                lng: latLng.lng()
            };
            
            // Update marker
            dropMarker.setPosition(latLng);
            dropMarker.setVisible(true);
            
            // Reverse geocode the coordinates
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ location: latLng }, (results, status) => {
                if (status === "OK" && results[0]) {
                    $("#dropAddress").val(results[0].formatted_address);
                    
                    // If pickup location is also set, draw route
                    if (pickupLatLng) {
                        drawRoute();
                    }
                    
                    // Adjust map bounds
                    adjustMapBounds();
                } else {
                    console.error("Geocoder failed due to: " + status);
                    $("#dropAddress").val(`${latLng.lat().toFixed(6)}, ${latLng.lng().toFixed(6)}`);
                }
            });
        }
        
        // Update slot users display
        function updateSlotUsers() {
            if (!connected) return;
            
            $.ajax({
                url: `/api/slots/${slotId}/users`,
                type: "GET",
                success: function(response) {
                    const $slotUsers = $("#slotUsers");
                    $slotUsers.empty();
                    
                    if (response.length > 0) {
                        $slotUsers.append('<div class="small text-muted mb-1">Users in this slot:</div>');
                        
                        response.forEach(user => {
                            const isCurrentUser = user.userId === userId;
                            $slotUsers.append(`
                                <span class="slot-user ${isCurrentUser ? 'current' : ''}">
                                    ${user.userId} ${isCurrentUser ? '(you)' : ''}
                                </span>
                            `);
                        });
                    }
                },
                error: function(error) {
                    console.error("Failed to get slot users:", error);
                }
            });
        }
        
        // Update trip metrics (distance, ETA)
        function updateTripMetrics(pickupLat, pickupLng, dropLat, dropLng) {
            if (!directionsService) return;
            
            const origin = new google.maps.LatLng(pickupLat, pickupLng);
            const destination = new google.maps.LatLng(dropLat, dropLng);
            
            directionsService.route(
                {
                    origin: origin,
                    destination: destination,
                    travelMode: google.maps.TravelMode.DRIVING
                },
                (response, status) => {
                    if (status === "OK") {
                        const route = response.routes[0];
                        
                        // Update distance and duration
                        if (route && route.legs && route.legs[0]) {
                            const leg = route.legs[0];
                            $("#tripDistance").text(leg.distance.text);
                            $("#tripEta").text(leg.duration.text);
                        }
                    }
                }
            );
        }
        
        // Event listeners
        $(document).ready(function() {
            $("#connectBtn").click(connect);
            $("#disconnectBtn").click(disconnect);
            $("#requestTripBtn").click(requestTrip);
            $("#scheduleRideBtn").click(scheduleRide);
            
            // Handle page unload
            $(window).on('beforeunload', function() {
                disconnect();
            });
        });
    </script>
    
    <!-- Load Google Maps API with the required libraries -->
    <script async defer 
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCelDo4I5cPQ72TfCTQW-arhPZ7ALNcp8w&libraries=places,directions&callback=initMap&v=weekly">
    </script>
</body>
</html>